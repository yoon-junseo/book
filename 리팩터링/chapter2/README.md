## 리팩터링 정의

<hr />

- 리팩터링: [명사] 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법
- 리팩터링하다: [동사] 소프트웨어의 겉보기 동작은 그대로 유지한 채, 여러 가지 리팩터링 기법을 적용해서 소프트웨어를 재구성하다.
- 리팩터링은 동작을 보존하는 작은 단계들을 거쳐 코드를 수정하고, 이러한 단계들을 순차적으로 연결하여 큰 변화를 만들어내는 일이다.
- 리팩터링하는 동안에는 코드가 항상 정상 작동하기 때문에 전체 작업이 끝나지 않았더라도 언제든 멈출 수 있다.
- 리팩터링 과정에서 발견된 버그는 리팩터링 후에도 그대로 남아 있어야 한다.
- 리팩터링의 목적은 코드를 이해하고 수정하기 쉽게 만드는 것이다.

<br />

## 리팩터링하는 이유

<hr />

### 코드를 건강한 상태로 유지하는 데 도움을 준다.

- 리팩터링을 통해 소프트웨어 설계를 더 좋게 만들 수 있다.
- 규칙적인 리팩터링은 코드의 구조를 지탱해줄 것이다.
- 중복 코드 제거는 설계 개선 작업의 중요한 한 축을 차지한다.
- 중복 코드 제거는 모든 코드가 언제나 고유한 일을 수행함을 보장할 수 있으며, 이는 바람직한 설계의 핵심이다.

### 리팩터링 하면 소프트웨어를 이해하기 쉬워진다.

- 리팩터링을 통해 코드의 의도를 더 명확하게 할 수 있다.

### 리팩터링 하면 버그를 쉽게 찾을 수 있다.

- 코드를 이해하기 쉽다는 말은 버그를 찾기 쉽다는 말이기도 하다.
- 리팩터링을 하면 코드가 하는 일을 깊이 파악하게 되면서 새로 깨달은 것을 곧바로 코드에 반영하게 된다.

### 리팩터링하면 프로그래밍 속도를 높일 수 있다.

- 리팩터링하면 코드 개발 속도를 높일 수 있다.
- 내부 설계가 잘 된 소프트웨어는 새로운 기능을 추가할 지점과 어떻게 쉽게 찾을 수 있다.
- 코드가 명확하면 버그를 만들 가능성도 줄고, 버그를 만들더라도 디버깅하기가 훨씬 쉽다.

<br />

## 언제 리팩터링 해야 할까?

<hr />

### 3의 법칙

1. 처음에는 그냥 한다.
2. 비슷한 일을 두 번째로 하게 되면, 일단 계속 진행한다.
3. 비슷한 일을 세 번째 하게 되면 리팩터링한다.

### 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기

- 리팩터링하기 가장 좋은 시점은 코드베이스에 기능을 새로 추가하기 직전이다.
- 현재 코드를 살펴보면서, 구조를 살짝 바꾸면 다른 작업을 하기가 훨씬 쉬워질 만한 부분을 찾는다.

### 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들 기

- 코드를 수정하려면 먼저 그 코드가 하는 일을 파악해야 한다.
- 코드의 의도가 더 명확하게 드러나도록 리팩터링할 여지는 없는지 확인해야 한다.
- 코드가 깔끔하게 정리 되면 보이지 않던 설계가 눈에 들어온다.

### 쓰레기 줍기 리팩터링

- 코드 파악 중, 로직이 쓸데없이 복잡하거나, 매개변수화한 함수 하나면 될 일을 거의 똑같은 함수 여러 개로 작성해놨을 수 있다.
- 위와 같은 문제가 있는 경우, 원래 하려던 작업과의 절충이 필요하다.
- 간단히 수정할 수 있는 것은 즉시 고치고, 시간이 좀 걸리는 일은 짧은 메모만 남긴 다음, 하던 일을 끝내고 나서 처리한다.

### 계획된 리팩터링과 수시로 하는 리팩터링

- 리팩터링을 프로그래밍 과정에 자연스럽게 녹여라.
- 보기 싫은 코드를 발견하면 리팩터링 하자. 그런데 잘 작성된 코드 역시 수많은 리팩터링을 거쳐야 한다.
- 무언가 수정하려 할 때는 먼저 수정하기 쉽게 정돈하고, 그런 다음 쉽게 수정하자.
- 새 기능을 추가하기 쉽도록 코드를 수정하는 것이 그 기능을 가장 빠르게 추가하는 길이 될 수 있다.

### 오래 걸리는 리팩터링

- 라이브러리를 새 것으로 교체하거나, 공통 컴포넌트로 빼내는 작업은 오래 걸릴 수 있다.
- 라이브러리를 교체할 때는 기존 것과 새 것 모두를 포용하는 추상 인터페이스부터 마련한다. 기존 코드가 이 추상 인터페이스를 호출하도록 만들고 나면 라이브러리를 훨씬 쉽게 교체할 수 있다.

### 코드 리뷰에 리팩터링 활용하기

- 중복 코드가 없다면, 한 부분만 수정하면 사용하는 모든 곳에 반영이 되기 때문에 작업이 편하다.
- 코드 리뷰를 통해 다른 사람의 아이디어를 얻을 수 있다.
- 리팩터링은 코드 리뷰의 결과를 더 구체적으로 도출하는 데에도 도움된다.
- 가장 좋은 방법은 페어 프로그래밍이다.

### 리팩터링하지 말아야 할 때

- 외부 API 다루듯 호출해서 쓰는 코드라면 지저분해도 그냥 둔다. 내부 동작을 이해해야 할 시점에 리팩터링해야 효과를 제대로 볼 수 있다.
- 리팩터링하는 것보다 처음부터 새로 작성하는 게 쉬울 때도 리팩터링하지 않는다.

<br />

## 리팩터링시 고려할 문제

<hr />

### 새 기능 개발 속도 저하

- 리팩터링의 궁극적인 목적은 개발 속도를 높이는 데 있다. 이를 통해 더 적은 노력으로 더 많은 가치를 창출하는 것이다.
- 새 기능을 구현하기 편해지겠다 싶은 리팩터링이라면 주저하지 않고 리팩터링을 하자.
- 코드 베이스가 건강하면 기존 코드를 새로운 방식으로 조합하기 쉬워서 복잡한 새 기능을 더 빨리 추가할 수 있다.
- 리팩터링은 단순히 코드를 이쁘게 만들기 위해 하는 것이 아닌, 경제적인 이유로 하는 것이다. 기능 추가 시간을 줄이고, 버그 수정 시간을 줄이기 위함이다.

### 코드 소유권

- 코드 소유권이 작은 단위로 나눠지면, 가령 함수명을 바꾸는 경우 고려 대상이 많아진다.
- 클라이언트에 영향을 주지 않기 위해 기존 함수도 그대로 유지하되 함수 본문에서 새 함수를 호출하도록 수정한다.

### 브랜치

- 개별 브랜치를 활용하면 기능이 추가될 때마다 버전을 명확히 나눌 수 있고, 기능에 문제가 생기면 이전 상태로 쉽게 되돌릴 수 있어서 좋다.
- 단점은 독립 브랜치로 작업하는 기간이 길어질수록 작업 결과를 마스터로 통합하기가 어려워진다. 이 고통을 줄이고자 마스터를 개인 브랜치로 수시로 리베이스하거나 머지하는 방법이 있다.
- 마스터를 브랜치로 머지하는 작업은 단방향이다. 브랜치만 바뀌고 마스터는 그대로다.
- 통합은 마스터를 개인 브랜치로 가져와서(pull) 작업한 결과를 다시 마스터에 올리는(push) 양방향 처리를 뜻한다.
- 머지가 복잡해지는 문제는 기능별 브랜치들이 독립적으로 개발되는 기간이 길어질수록 기하급수적으로 늘어난다. 따라서 기능별 브랜치의 통합 주기를 2~3일 단위로 짧게 관리하는 것이 좋다고 한다.
- CI(지속적 통합)은 머지의 복잡도를 줄일 수 있고, 리팩터링과 궁합이 좋다. 통합 주기는 짧으면 짧을수록 좋다.

### 테스팅

- 리팩터링의 두드러진 특성은 프로그램의 겉보기 동작은 똑같이 유지된다는 것이다.
- 리팩터링의 핵심은 오류가 발생하면 오류를 재빨리 잡는 데 있다. 이는 리팩터링 하기 위해서는 자가 테스트 코드를 마련해야함을 의미한다.
- 자가 테스트 코드는 리팩터링을 할 수 있게 해줄 뿐만 아니라, 새 기능 추가도 훨씬 안전하게 진행할 수 있도록 도와준다.

### 레거시 코드

- 물려받은 레거시 코드는 대체로 복잡하고 테스트도 갖춰지지 않은 것이 많다.
- 대규모 레거시 시스템을 테스트 코드 없이 명료하게 리팩터링하기는 어렵다.
- 레거시 시스템의 규모가 크다면 자주 보는 부분을 더 많이 리팩터링한다.

### 데이터 베이스

- 전체 변경 과정을 작고 독립된 단계들로 쪼개는 것이 핵심이다.
- 단계를 잘게 나누면 코드도 쉽게 작성할 수 있다.
- 데이터 베이스 리팩터링은 프로덕션 환경에 여러 단계로 나눠서 릴리스하는 것이 대체로 좋다는 점에서 다른 리팩터링과 다르다.

<br />

## 리팩터링, 아키텍처, 애그니(YAGNI)

<hr />

- 향후 변경에 유연하게 대처할 수 있는 유연성 메커니즘을 소프트웨어에 심어두는 것이 좋다. 이는 추후 시나리오를 예상하고 미리 상황에 대처하는 것이다.
- 앞으로 어느 부분에 유연성이 필요하고 어떻게 해야 그 변화에 가장 잘 대응할 수 있을지 추측하지 않고, 그저 현재까지 파악한 요구사항만을 해결하는 소프트웨어를 구축하고, 복잡도를 높일 수 있는 유연성 메커니즘은 반드시 검증을 거친 후에 추가한다.
- 리팩터링을 미루면 훨씬 힘들어진다는 확신이 들 때만 유연성 메커니즘을 미리 추가한다.
- 위와 같은 설계 방식을 간결한 설계, 점진적 설계, YAGNI 라고 부른다.

<br />

## 리팩터링과 소프트웨어 개발 프로세스

<hr />

- 자가 테스트 코드와 리팩터링을 묶어서 테스트 주도 개발(TDD)이라고 한다.
- 애자일을 제대로 적용하려면 리팩터링에 대한 팀의 역량과 열정이 뒷받침 되어 프로세스 전반에 리팩터링이 자연스럽게 스며들도록 해야 한다.
- 리팩터링의 첫 번째 토대는 자가 테스트 코드다.
- 팀으로 개발하면서 리팩터링을 하려면 각 팀원이 다른 사람의 작업을 방해하지 않으면서 언제든지 리팩터링 할 수 있게 CI를 권장한다.
- 자가 테스트 코드는 CI의 핵심 요소다.
- 자가 테스트 코드, CI, 리팩터링은 서로 강력한 상승 효과를 발휘한다.
- CI는 소프트웨어를 언제든 릴리스 할 수 있는 상태로 유지해준다.
